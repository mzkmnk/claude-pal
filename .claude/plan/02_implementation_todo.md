# Claude PAL 実装計画書（TODO）

## プロジェクト方針
- **目的**: Claude CodeをiPhoneで快適に操作するためのUI/UXに特化したアプリ
- **ターゲット**: iOS専用（iPhone/iPad）
- **SSH接続**: シンプルな実装（高度な機能はTermius等に任せる）
- **実装順序**: iOS専用バックエンド → デモUI → 本格的UI
- **iOS固有機能の活用**: Keychain、Touch ID/Face ID、Haptic Feedback等

## プラットフォーム対応状況

### 現在の対応プラットフォーム
- **iOS**: ✅ 対応（メインターゲット）
- **Android**: ❌ 未対応（将来的な対応予定なし）
- **Web (PWA)**: ⚠️ 部分対応（フォールバック実装のみ）

### 注記
本プロジェクトは現在**iOSのみ**を対象として開発を進めています。
- Android関連の実装は行いません
- Web版は開発時の動作確認用として最小限の実装のみ提供
- iOS固有の機能（Keychain等）を積極的に活用

## Phase 1: プロジェクト初期設定

### 環境構築
- [x] Ionic CLIのインストール確認
- [x] Node.js 20.x のインストール確認
- [x] 新規Ionicプロジェクトの作成
  - [x] `ionic start claude-pal tabs --type=angular --capacitor`
  - [x] プロジェクトディレクトリへ移動
  - [x] 初期ビルドの確認
- [x] 必要なパッケージのインストール
  - [x] SSH関連: `node-forge`（鍵生成用、SSH接続はネイティブ実装）
  - [x] ターミナル: `npm install xterm xterm-addon-fit xterm-addon-web-links`
  - [x] セキュリティ: `npm install crypto-js`
  - [x] UI追加: `npm install @ionic/pwa-elements`
- [x] Capacitorプラットフォームの追加
  - [x] `ionic capacitor add ios`
- [x] ESLint/Prettier設定
  - [x] `.eslintrc.json`の作成
  - [x] `.prettierrc`の作成
  - [x] pre-commitフックの設定
- [ ] **iOS開発環境の設定**
  - [ ] Xcode 15以上のインストール確認
  - [ ] iOS Simulatorの設定
  - [ ] 開発用証明書の準備
  - [ ] `ionic capacitor run ios`での動作確認

### プロジェクト構造の整備
- [ ] ディレクトリ構造の作成
  - [ ] `src/app/core`ディレクトリ作成
  - [ ] `src/app/shared`ディレクトリ作成
  - [ ] `src/app/features`ディレクトリ作成
- [ ] 環境変数ファイルの設定
  - [ ] `environment.ts`の更新
  - [ ] `environment.prod.ts`の更新
- [ ] アセットの準備
  - [ ] アプリアイコンの作成
  - [ ] スプラッシュスクリーンの作成

## Phase 2: コアサービス実装

### SSH鍵管理サービス（iOS Keychain特化）
- [x] `key-manager.service.ts`の作成
- [x] 鍵生成機能の実装
  - [x] RSA 4096bit鍵ペアの生成（node-forge使用）
  - [x] OpenSSH形式への変換
  - [x] フィンガープリントの計算
- [x] iOS Keychain統合
  - [x] SecItemAdd/SecItemUpdateによる鍵保存
  - [x] Touch ID/Face ID連携
  - [x] アクセス制御（kSecAccessControlBiometryAny）
  - [x] 開発用Web版のフォールバック実装
- [x] 鍵取得機能の実装
  - [x] 生体認証によるアンロック
  - [x] Keychainエラーハンドリング
- [x] 鍵削除機能の実装
- [x] 鍵一覧取得機能の実装
- [x] 単体テストの作成

### ストレージサービス
- [x] `storage.service.ts`の作成
- [x] Capacitor Preferencesのラッパー実装
- [x] 接続プロファイルの保存/読み込み
- [x] アプリ設定の保存/読み込み
- [x] データ暗号化の実装
- [x] マイグレーション機能の実装
- [x] 単体テストの作成

### SSH接続サービス
- [x] `ssh.service.ts`の作成
- [x] SSH接続の確立機能
  - [x] ~~ssh2ライブラリの統合~~ モック実装（後でネイティブ実装に置き換え）
  - [x] 認証処理の実装
  - [x] エラーハンドリング
- [x] シェルセッションの管理
- [x] コマンド実行機能
- [x] データストリームの処理
- [x] 接続状態の管理
- [x] 自動再接続機能
- [x] 単体テストの作成

### プロファイル管理サービス
- [x] `profile.service.ts`の作成
- [x] プロファイルのCRUD操作
- [x] デフォルトプロファイルの管理
- [x] 最近使用したプロファイルの追跡
- [x] プロファイルのバリデーション
- [x] 単体テストの作成

## Phase 3: iOS専用バックエンド機能実装（最優先）

### Capacitor SSH Plugin開発（iOS専用）
- [x] **カスタムCapacitorプラグインの作成**
  - [x] ~~`npm init @capacitor/plugin claude-pal-ssh`でプラグイン雛形作成~~ プロジェクト内に直接実装
  - [x] iOS専用プラグインとして設定（Android除外）
  - [x] Swift 5.0以上での実装準備
- [x] **プラグインAPIの設計**
  - [x] TypeScript定義ファイルの作成（ssh-plugin.ts）
  - [x] iOS実装とのインターフェース定義（SSHPlugin.swift, SSHPlugin.m）
  - [x] エラーハンドリング設計
- [x] **モック実装**
  - [x] iOSプラグインのモック実装（SSHPlugin.swift）
  - [x] 接続/切断のシミュレーション
  - [x] データ送受信のモック

### iOSネイティブSSHライブラリの統合
- [ ] **NMSSHライブラリの統合**
  - [ ] NMSSH（libssh2ベース）の採用検討
  - [ ] CocoaPodsでの依存関係設定
  - [ ] Swiftブリッジングヘッダーの設定

### iOS SSH実装（Swift）
- [ ] **SSH接続機能の実装**
  - [ ] NMSSHSessionラッパーの作成
  - [ ] ホスト/ポート/ユーザー名での接続
  - [ ] パスワード認証の実装
  - [ ] SSH秘密鍵認証（文字列/Keychain）
  - [ ] 接続タイムアウトの設定
- [ ] **シェルセッション管理**
  - [ ] PTYサイズの設定（行/列）
  - [ ] シェルチャンネルの開設
  - [ ] 非同期データストリーム処理
  - [ ] セッション状態の監視
- [ ] **データ通信の実装**
  - [ ] コマンド送信（UTF-8エンコーディング）
  - [ ] 出力受信（ストリーミング）
  - [ ] ANSIエスケープシーケンスのパススルー
  - [ ] バッファ管理とフロー制御

### Capacitorブリッジ実装
- [x] **JavaScript⇔Native通信**
  - [x] Capacitorプラグインメソッドの実装（connect, sendCommand, resizeWindow, disconnect）
  - [x] イベントリスナー（データ受信、状態変更）
  - [x] Promise/Callbackパターンの実装
- [x] **xterm.js統合（UI側）**
  - [x] Tab3でのPlugin使用
  - [x] データストリームのxterm.write()への接続
  - [x] キーボード入力のPlugin送信
  - [x] ウィンドウサイズ変更の同期

### iOS固有機能の活用
- [ ] **Keychainとの統合**
  - [ ] SSH秘密鍵のKeychain保存
  - [ ] Touch ID/Face IDでの鍵アンロック
  - [ ] 鍵のアクセス制御設定
- [ ] **バックグラウンド処理**
  - [ ] Background Modesの設定（必要に応じて）
  - [ ] セッション維持の検討
  - [ ] 省電力対応

## Phase 4: UIコンポーネント実装

### デモUI実装（Tab1, Tab3）
- [x] SSH鍵管理デモ画面の作成（Tab1）
- [x] 鍵生成フォームの実装
- [x] 鍵一覧表示の実装
- [x] 鍵詳細表示機能
- [x] 公開鍵コピー機能
- [x] 鍵削除機能（確認ダイアログ付き）
- [x] SSH接続デモ画面の作成（Tab3）
  - [x] 接続フォーム（ホスト、ポート、ユーザー名、認証方法）
  - [x] ターミナルコンポーネントとの統合
  - [x] 接続/切断機能

### ターミナルコンポーネント
- [x] `terminal.component.ts`の作成
- [x] xterm.jsの統合
  - [x] 基本的なターミナル表示
  - [x] テーマ設定（ダークテーマ）
  - [x] フォント設定
- [x] 入力処理の実装
  - [x] キーボード入力の処理
  - [x] 特殊キーの処理（Ctrl, Alt等）
  - [x] コピー&ペーストの実装
- [x] 出力処理の実装
  - [x] ANSIエスケープシーケンスの処理
  - [x] スクロール機能
  - [x] 画面クリア機能
- [x] アドオンの統合
  - [x] fit addon（自動サイズ調整）
  - [x] web-links addon（URLクリック）
  - [x] search addon（検索機能）
- [x] レスポンシブ対応
- [x] ジェスチャー操作の実装
- [x] 単体テストの作成

### メッセージコンポーネント
- [x] `message.component.ts`の作成
- [x] メッセージタイプ別の表示
  - [x] ユーザーメッセージ
  - [x] Claude出力
  - [x] システムメッセージ
  - [x] エラーメッセージ
- [x] コードハイライト機能
- [x] タイムスタンプ表示
- [x] アニメーション実装
- [x] 単体テストの作成

### SSH鍵カードコンポーネント
- [ ] `ssh-key-card.component.ts`の作成
- [ ] 鍵情報の表示
- [ ] 公開鍵のコピー機能
- [ ] 削除確認ダイアログ
- [ ] 単体テストの作成

### 接続フォームコンポーネント
- [ ] `connection-form.component.ts`の作成
- [ ] フォームバリデーション
- [ ] 入力補助機能
- [ ] エラー表示
- [ ] 単体テストの作成

## Phase 5: iOS向けデモ画面実装（最小限）

### 接続画面（iOS UIガイドライン準拠）
- [ ] **基本的な接続フォーム**
  - [ ] ホスト入力フィールド（iOS標準テキストフィールド）
  - [ ] ポート入力フィールド（数値キーパッド、デフォルト: 22）
  - [ ] ユーザー名入力フィールド
  - [ ] 認証方法選択（セグメントコントロール: パスワード/SSH鍵）
  - [ ] 接続ボタン（iOS標準スタイル）
- [ ] **保存済みプロファイル表示**
  - [ ] iOS標準のTableView風リスト
  - [ ] スワイプで削除アクション
  - [ ] タップで選択・接続
  - [ ] 3D Touchでプレビュー（対応機種）

### ターミナル画面（iOS最適化）
- [ ] **ターミナル表示**
  - [ ] xterm.jsの基本統合
  - [ ] iOS向けフォントサイズ調整
  - [ ] Safe Areaへの対応
  - [ ] ダークモード対応
- [ ] **iOS向け操作**
  - [ ] ソフトキーボードの最適化
  - [ ] ツールバーでのよく使うキー（Tab, Ctrl, Esc）
  - [ ] ピンチジェスチャーでズーム
  - [ ] 長押しでコンテキストメニュー

### iOS固有のエラー処理
- [ ] **接続エラーの表示**
  - [ ] iOS標準のアラート表示
  - [ ] Haptic Feedbackでの通知
  - [ ] 再試行ボタン

## Phase 6: 画面実装（本格版）

### チャット画面
- [ ] `chat.page.ts`の作成
- [ ] メッセージ一覧の表示
- [ ] 入力エリアの実装
  - [ ] 自動高さ調整
  - [ ] Shift+Enterで改行
  - [ ] Enterで送信
- [ ] コマンド履歴機能
- [ ] 入力補完機能（基本）
- [ ] スクロール制御
- [ ] 画面遷移アニメーション
- [ ] 統合テストの作成

### ターミナル画面
- [ ] `terminal.page.ts`の作成
- [ ] ターミナルコンポーネントの統合
- [ ] ツールバーの実装
  - [ ] 接続状態表示
  - [ ] クリアボタン
  - [ ] 設定ボタン
- [ ] フルスクリーンモード
- [ ] 画面回転対応
- [ ] 統合テストの作成

### SSH鍵管理画面
- [ ] `keys.page.ts`の作成
- [ ] 鍵一覧の表示
- [ ] 新規鍵生成フォーム
- [ ] 鍵詳細モーダル
- [ ] インポート機能（オプション）
- [ ] エクスポート機能
- [ ] 統合テストの作成

### 接続設定画面
- [ ] `connection.page.ts`の作成
- [ ] プロファイル一覧
- [ ] 新規接続フォーム
- [ ] プロファイル編集
- [ ] 接続テスト機能
- [ ] クイック接続
- [ ] 統合テストの作成

### 設定画面
- [ ] `settings.page.ts`の作成
- [ ] テーマ設定
- [ ] ターミナル設定
  - [ ] フォントサイズ
  - [ ] カラースキーム
  - [ ] スクロールバック行数
- [ ] セキュリティ設定
  - [ ] 生体認証の有効/無効
  - [ ] 自動ロック時間
- [ ] アプリ情報
- [ ] 統合テストの作成

## Phase 7: 高度な機能実装

### コマンドテンプレート
- [ ] テンプレート管理サービスの作成
- [ ] よく使うコマンドの保存
- [ ] カテゴリ分け機能
- [ ] テンプレート実行機能
- [ ] カスタマイズ可能な変数

### 履歴管理
- [ ] コマンド履歴の保存
- [ ] 履歴検索機能
- [ ] 履歴のクリア
- [ ] 履歴のエクスポート

### セッション管理
- [ ] 複数セッションの対応
- [ ] セッション切り替え
- [ ] バックグラウンドセッション
- [ ] セッション復元機能

### Claude Code最適化
- [ ] Claude特有のコマンド認識
- [ ] 出力のパース最適化
- [ ] コンテキスト認識
- [ ] スマート提案機能

## Phase 8: ポリッシュと最適化

### パフォーマンス最適化
- [ ] レイジーローディングの実装
- [ ] 画像最適化
- [ ] バンドルサイズの削減
- [ ] メモリリークの確認と修正
- [ ] 起動時間の最適化

### UI/UXの改善
- [ ] アニメーションの追加
- [ ] ローディング表示
- [ ] エラー表示の改善
- [ ] ダークモードの完全対応
- [ ] アクセシビリティ対応

### セキュリティ強化
- [ ] 入力のサニタイゼーション
- [ ] XSS対策
- [ ] セキュアストレージの検証
- [ ] 通信の暗号化確認

## Phase 9: テストとドキュメント

### E2Eテスト
- [ ] 主要フローのE2Eテスト作成
- [ ] デバイス別テスト
- [ ] エラーケースのテスト

### ドキュメント作成
- [ ] README.mdの作成
- [ ] セットアップガイド
- [ ] ユーザーマニュアル
- [ ] トラブルシューティングガイド
- [ ] API仕様書（内部用）

### リリース準備
- [ ] App Store用のスクリーンショット作成
- [x] Google Play用のスクリーンショット作成は不要（iOSのみ対応）
- [ ] プライバシーポリシーの作成
- [ ] 利用規約の作成
- [ ] アプリ説明文の作成

## Phase 10: デプロイと公開

### ビルドと署名
- [ ] iOS用のProvisioning Profile設定
- [x] Android用の署名設定は不要（iOSのみ対応）
- [ ] 本番ビルドの作成
- [ ] ビルドの検証

### ストア申請
- [ ] App Store Connect設定
- [x] Google Play Console設定は不要（iOSのみ対応）
- [ ] メタデータの入力
- [ ] 審査提出

### CI/CD設定（オプション）
- [ ] GitHub Actions設定
- [ ] 自動ビルドの設定
- [ ] 自動テストの設定


## 優先度

1. **最優先**（Phase 3）: iOS専用SSH接続のネイティブ実装（Capacitorプラグイン開発）
2. **必須**（Phase 5）: iOS向け最小限のデモUI
3. **必須**（Phase 1-2,4,6）: 基本的なアプリ構造とiOS最適化UI
4. **重要**（Phase 7）: Claude Code用のiOS向け最適化
5. **改善**（Phase 8-9）: 品質向上とiOS固有機能の活用
6. **リリース**（Phase 10）: App Store公開

## 技術スタック（iOS専用）

- **フロントエンド**: Ionic 8.6 + Angular 20 + Capacitor 7.4
- **ネイティブ**: Swift 5.0+ / Objective-C（NMSSH）
- **SSH実装**: カスタムCapacitorプラグイン + NMSSH（libssh2）
- **セキュリティ**: iOS Keychain Services + Biometric認証
- **開発環境**: Xcode 15+、iOS 15.0+対応